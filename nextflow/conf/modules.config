/*
========================================================================================
    Module-specific Configuration
========================================================================================
*/

process {
    // Alignment processes
    withName: 'BOWTIE2_ALIGN' {
        cpus   = { check_max(params.atacseq.mapper == 'bowtie2' ? 32 : 2, 'cpus') }
        memory = { check_max(32.GB * task.attempt, 'memory') }
        time   = { check_max(12.h * task.attempt, 'time') }
        ext.args = { params."${meta.type}".bowtie2_opts ?: '--very-sensitive' }
        publishDir = [
            path: { "${params.outdir}/${params.genome_id}/${meta.type}/bam" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'BWA_MEM' {
        cpus   = { check_max(32, 'cpus') }
        memory = { check_max(32.GB * task.attempt, 'memory') }
        time   = { check_max(12.h * task.attempt, 'time') }
        ext.args = { params."${meta.type}".bwa_mem2_opts ?: '-M' }
        publishDir = [
            path: { "${params.outdir}/${params.genome_id}/${meta.type}/bam" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    // SAMtools processes
    withName: 'SAMTOOLS_SORT' {
        cpus   = { check_max(8, 'cpus') }
        memory = { check_max(36.GB * task.attempt, 'memory') }
        ext.prefix = { "${meta.id}.sorted" }
        publishDir = [
            path: { "${params.outdir}/${params.genome_id}/${meta.type}/bam" },
            mode: params.publish_dir_mode,
            pattern: '*.bam'
        ]
    }
    
    withName: 'SAMTOOLS_INDEX' {
        publishDir = [
            path: { "${params.outdir}/${params.genome_id}/${meta.type}/bam" },
            mode: params.publish_dir_mode,
            pattern: '*.bai'
        ]
    }
    
    // Duplicate marking
    withName: 'PICARD_MARKDUPLICATES' {
        cpus   = { check_max(4, 'cpus') }
        memory = { check_max(36.GB * task.attempt, 'memory') }
        ext.prefix = { "${meta.id}.marked" }
        ext.args = 'REMOVE_DUPLICATES=false VALIDATION_STRINGENCY=LENIENT'
        publishDir = [
            [
                path: { "${params.outdir}/${params.genome_id}/${meta.type}/bam" },
                mode: params.publish_dir_mode,
                pattern: '*.bam'
            ],
            [
                path: { "${params.outdir}/${params.genome_id}/${meta.type}/picard_metrics" },
                mode: params.publish_dir_mode,
                pattern: '*.metrics.txt'
            ]
        ]
    }
    
    // Peak calling
    withName: 'MACS3_CALLPEAK' {
        cpus   = { check_max(4, 'cpus') }
        memory = { check_max(16.GB * task.attempt, 'memory') }
        time   = { check_max(8.h * task.attempt, 'time') }
        ext.args = { params."${meta.type}".macs3_opts ?: '--qval 0.05' }
        publishDir = [
            path: { "${params.outdir}/${params.genome_id}/${meta.type}/peaks" },
            mode: params.publish_dir_mode,
            pattern: '*.{narrowPeak,broadPeak,xls,bed}'
        ]
    }
    
    // BigWig generation
    withName: 'DEEPTOOLS_BAMCOVERAGE' {
        cpus   = { check_max(8, 'cpus') }
        memory = { check_max(32.GB * task.attempt, 'memory') }
        ext.args = { 
            def norm = params."${meta.type}".bw_norm ?: 'CPM'
            "--binSize 10 --normalizeUsing ${norm}"
        }
        publishDir = [
            path: { "${params.outdir}/${params.genome_id}/${meta.type}/bigwig" },
            mode: params.publish_dir_mode,
            pattern: '*.bw'
        ]
    }
    
    // QC processes
    withName: 'FASTQC' {
        cpus   = { check_max(4, 'cpus') }
        memory = { check_max(8.GB * task.attempt, 'memory') }
        publishDir = [
            path: { "${params.outdir}/${params.genome_id}/qc/fastqc" },
            mode: params.publish_dir_mode
        ]
    }
    
    withName: 'FASTP' {
        cpus   = { check_max(4, 'cpus') }
        memory = { check_max(8.GB * task.attempt, 'memory') }
        ext.args = { 
            "--qualified_quality_phasing ${params.adapter_trimming.quality_cutoff} " +
            "--length_required ${params.adapter_trimming.min_length}"
        }
        publishDir = [
            [
                path: { "${params.outdir}/${params.genome_id}/trimmed" },
                mode: params.publish_dir_mode,
                pattern: '*.fastq.gz',
                enabled: false  // Don't publish trimmed reads by default
            ],
            [
                path: { "${params.outdir}/${params.genome_id}/qc/fastp" },
                mode: params.publish_dir_mode,
                pattern: '*.{json,html}'
            ]
        ]
    }
    
    withName: 'MULTIQC' {
        cpus   = { check_max(4, 'cpus') }
        memory = { check_max(8.GB * task.attempt, 'memory') }
        publishDir = [
            path: { "${params.outdir}/${params.genome_id}/qc" },
            mode: params.publish_dir_mode
        ]
    }
    
    // Genome preparation
    withName: 'BOWTIE2_BUILD' {
        cpus   = { check_max(8, 'cpus') }
        memory = { check_max(36.GB * task.attempt, 'memory') }
        time   = { check_max(8.h * task.attempt, 'time') }
        publishDir = [
            path: { "${params.outdir}/${params.genome_id}/genome/bowtie2" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'BWA_INDEX' {
        cpus   = { check_max(8, 'cpus') }
        memory = { check_max(36.GB * task.attempt, 'memory') }
        time   = { check_max(8.h * task.attempt, 'time') }
        publishDir = [
            path: { "${params.outdir}/${params.genome_id}/genome/bwa_mem2" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'SAMTOOLS_FAIDX' {
        publishDir = [
            path: { "${params.outdir}/${params.genome_id}/genome" },
            mode: params.publish_dir_mode
        ]
    }
    
    // UCSC hub generation
    withName: 'UCSC_HUB' {
        cpus   = { check_max(2, 'cpus') }
        memory = { check_max(4.GB, 'memory') }
        publishDir = [
            path: { "${params.outdir}/${params.genome_id}/ucsc" },
            mode: params.publish_dir_mode
        ]
    }
}
